---
title: "Population Mixed Effects"
output: html_notebook
---

Mixed effects model runs fine as per Russells' code. 
I had trouble with the boxcox, choosing the best transformation but other than that works really well.


Load in libraries
```{r}
library(tidyr)
library(MASS)
library(sf)
library(rgeos)
library(gmt)
library(lme4)
library(lmerTest)
library(ggplot2)
```



My manipulation of the data is very convoluted compared to Russell's code since I've changed the CSV twice before this point lmao.
This code be why I had issues with boxcox?

Load in data
```{r}
df = read.csv("C:\\Users/Owner/OneDrive - Western Sydney University/Spring 2022/Mathematics Project/Data Sets (Need to organise)/populationLong.csv")
df$density <- 0.0    
df$density <- df$pop/df$area
df$yearsince2000 <- df$year-2000
head(df,5)
```


```{r}
syd <- st_read("C:\\Users/Owner/OneDrive - Western Sydney University/Spring 2022/Mathematics Project/Data Sets (Need to organise)/SA2_2016_AUST.shp")
syd <- syd[syd$GCC_NAME16=="Greater Sydney",]
centr <- st_centroid(syd)
```


```{r}
centroid_lat <- unlist(lapply(centr$geometry,function(l) l[2]))
centroid_long <- unlist(lapply(centr$geometry,function(l) l[1]))
```


```{r}
syd$sydist <- geodist(-33.8688,151.2093,centroid_lat,centroid_long)
syd$parradist <- geodist(-33.8148,151.0017,centroid_lat,centroid_long)
df$sydist <- syd$sydist[match(df$name,syd$SA2_NAME16)]
df$parradist <- syd$parradist[match(df$name,syd$SA2_NAME16)]

df$logsydist <- log(syd$sydist[match(df$name,syd$SA2_NAME16)])
df$logparradist <- log(syd$parradist[match(df$name,syd$SA2_NAME16)])
```

```{r}
head(df,100)
tail(df,100)
```
```{r}
# Drop SA2's without syddist
df <- df[!is.na(df$sydist),]
```


```{r}
head(df,100)
```



```{r}
head(df[order(df$density),], 200)
```


Having trouble running the boxcox
Can still do the square root transformation on the data but can prove it? 
```{r}
#model = lm(df$density~df$yearsince2000*df$parradist+df$yearsince2000*df$sydist)
#bc = boxcox(model)

#bc <- boxcox(lm(df$density~df$yearsince2000*df$parradist+df$yearsince2000*df$sydist))
#bc$x[which.max(bc$y)]
#Suggests sqrt transform

```


```{r}
df$trans_density <- sqrt(df$density)

# Fixed Effect Model
fit_fixed <- lm(trans_density~yearsince2000*parradist+yearsince2000*sydist,data=df)
summary(fit_fixed)
```


```{r}
# Mixed Effect Model, Random Intercepts
fit_randint <- lmer(trans_density~yearsince2000*logparradist*logsydist+(1|name),data=df)
summary(fit_randint)
# Random Intercept for each SA2  much bigger than residual variation
# this model better than fixed effect.

# Mixed Effect Model, Random Intercepts and Slopes
fit_randslope1 <- lmer(trans_density~yearsince2000*parradist*sydist+(yearsince2000|name),data=df)
summary(fit_randslope1)
# intercept random effect is small. 
```







```{r}
anova(fit_randint,fit_randslope1)
# Random slope model significantly better fit.

logsydist_1st_3rd_quartile <- quantile(df$logsydist,c(0.25,.75))
logparradist_1st_3rd_quartile <- quantile(df$logparradist,c(0.25,.75))
```


```{r}
preds <- data.frame(yearsince2000=rep(1:21,4)
                    ,logsydist=rep(logsydist_1st_3rd_quartile,each=21)
                    ,logparradist=rep(logparradist_1st_3rd_quartile,each=42)
                    ,pred_trans_density=NA)
preds$sydist <- factor( round(exp(preds$logsydist)) )
preds$parradist <- factor( round(exp(preds$logparradist)) )
preds$year <- preds$yearsince2000+2000

preds$pred_trans_density <- predict(fit_randslope1,newdata=preds,re.form=NA)

# Back transform density
preds$pred_density <- preds$pred_trans_density^2 

# Plot Predictions
i <- ggplot(preds,aes(year,pred_density)) + expand_limits(y = 0)
i + geom_line(aes(colour=sydist,linetype=parradist))
```


Next steps in mixed effect model


# Test Covid Effect... (with sep. coefficients for 2020 and 2021)


# Plot COVID Effect





