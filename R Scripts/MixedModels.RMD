---
title: "Mixed Models"
output: pdf_document
date: "2022-10-17"
---


--------------------------------------------------------------------------------
Mixed Effects Models
--------------------------------------------------------------------------------
Some definitions: 

Fixed effects:
Fixed effects are variables that are constant across individuals. Think of ethnicity
which doesn't change OR age which changes at a constant rate over time. These
are fixed effects. 

Limitations:
Variables that are random will be treated as though they are non-random. 
"For example, in regression analysis, “fixed effects” regression fixes 
(holds constant) average effects for whatever variable you think might affect the outcome of your analysis."

There is more talk on variables that require dummy variables but this doesn't
apply to our model.



Random effects models:
The variables are random/unpredictable. 
e.g the cost of a three course dinner would greatly vary depending on location.



Mixed-Models:
A mixture of fixed and random. 



```{r, warning=FALSE}
x <- c("ggmap", "rgdal", "rgeos", "maptools", "dplyr", "tidyr", "tmap", "sf", "MASS", "rgeos", "gmt", "lme4", "lmerTest", "ggplot2", "sf", "tidyverse", "gganimate")
lapply(x, library, character.only = TRUE) 
```

```{r}
dataPop = read.csv("C:\\Users/Owner/OneDrive - Western Sydney University/Spring 2022/Mathematics Project/Data Sets (Need to organise)/populationLong.csv")
```

```{r}
dataPop = subset(dataPop, select = -c(numChange,perChange) )
```

```{r}
dataPop$density <- 0.0    
dataPop$density <- dataPop$pop/dataPop$area
dataPop$yearsince2000 <- dataPop$year-2000
```


```{r}
dataPop$trans_density <- sqrt(dataPop$density)
```

```{r}
centr <- st_centroid(syd)

centroid_lat <- unlist(lapply(centr$geometry,function(l) l[2]))
centroid_long <- unlist(lapply(centr$geometry,function(l) l[1]))
```

```{r}
syd$sydist <- geodist(-33.8688,151.2093,centroid_lat,centroid_long)
syd$parradist <- geodist(-33.8148,151.0017,centroid_lat,centroid_long)
dataPop$sydist <- syd$sydist[match(dataPop$name,syd$SA2_NAME16)]
dataPop$parradist <- syd$parradist[match(dataPop$name,syd$SA2_NAME16)]

dataPop$logsydist <- log(syd$sydist[match(dataPop$name,syd$SA2_NAME16)])
dataPop$logparradist <- log(syd$parradist[match(dataPop$name,syd$SA2_NAME16)])

head(dataPop$sydist)
```

```{r}
# Drop SA2's without syddist
df <- df[!is.na(df$sydist),]
```

Mixed-Models:
A mixture of fixed and random. 

Fixed effects model.
```{r}
fit_fixed <- lm(trans_density~yearsince2000*parradist+yearsince2000*sydist,data=dataPop)
summary(fit_fixed)
```


Output Summary Interpretation:
I'm assuming we can interpret this in the same way we approached the linear
model. The only difference being the ways in which we examine the 
variables like yearsince2000:parradist and yearsince2000:sydist.

If so we can say this model performs poorly compared to the multiple linear 
regression and linear models above.


However, we've not used the transformed variables in this model? 
Try it with the normalized variables.

```{r}
fit_fixed_norm <- lm(trans_density~yearsince2000*logparradist+yearsince2000*logsydist,data=dataPop)
summary(fit_fixed_norm)
```

^ This performs similarly to the previous models. Accounting for roughly
59.51% of the variance in the data
The only concerning thing is that in both models yearsince2000:parradist
and yearsince2000:sydist are not apparently significant given their p-values. 

```{r}
rand_model_test <- lmer(trans_density~(1|name),data=dataPop)
summary(rand_model_test)
plot(rand_model_test)
qqnorm(resid(rand_model_test))
qqline(resid(rand_model_test))
```

Mixed Effect Model, Random Intercepts
```{r}
#| -> General sub scripting operator, selects top-level elements.
fit_randint <- lmer(trans_density~yearsince2000*logparradist*logsydist+(1|name),data=dataPop)
summary(fit_randint)
plot(fit_randint)
```

```{r}
ranEff = ranef(fit_randint)$name
#ranEff
```

Random Intercept for each SA2  much bigger than residual variation
this model better than fixed effect.


Mixed Effect Model, Random Intercepts and Slopes
```{r}
fit_randslope1 <- lmer(trans_density~yearsince2000*parradist*sydist+(yearsince2000|name),data=dataPop)
summary(fit_randslope1)
plot(fit_randslope1)
```

```{r}
ranEff = ranef(fit_randslope1)$name
ranEff
```

Intercept random effect is small. 


```{r}
anova(fit_randint,fit_randslope1)
```

Random slope model significantly better fit.


```{r}
dataPop$year2020 = (dataPop$yearsince2000 == 20)

dataPop$year2021= (dataPop$yearsince2000 == 21)
```


Random slope with year= 2020 and year = 2021 as predictors
```{r}
model_fit2 = lmer(trans_density ~ logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021 + (yearsince2000|name),data=dataPop)


random_coef = coef(model_fit2)$name
random_coef

#row.names(random_coef)
```


***********prediction fix************
```{r}
p <- predict(linear_model,newdata=data.frame(logparradist=c(0,1.609438), logsydist) )
```


Random int with year= 2020 and year = 2021 as predictors
```{r}
model_fit = lmer(trans_density ~ logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021 + (1|name),data=dataPop)

qqnorm(resid(model_fit))
qqline(resid(model_fit))
#plot(model_fit)
#summary(model_fit)
```

```{r}
print(model_fit, correlation=TRUE)
```


```{r}
random_eff = ranef(model_fit)$name
random_eff

random_coef = coef(model_fit)$name
random_coef
```



```{r}
length(syd$SA2_NAME16)
length(unique(syd$SA2_NAME16))

length(dataPop$name)
length(unique(dataPop$name))

length(unique(dataPop$sydist))
```
Use the match function to fix this:
dataPop$parradist <- syd$parradist[match(dataPop$name,syd$SA2_NAME16)]


================================================================================

Visualisation

Need this chunk to work for the next chunk
```{r}
fixed_effects = fixef(model_fit)
random_effects = 
  random_coef %>%
  mutate(name = factor(unique(dataPop$name)))
```

Since this SA2 data is from 2016 I can only really use SA2's with names consistent from 2016.
Drop missing ones?
This is an issue with trying to reproduce the next plot as well

```{r}
# This is how I want to plot the random slopes
# Pretty sure
dataPop %>% 
  ggplot(aes(logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021, trans_density)) +
  geom_point(aes(color = name), alpha = .25) +
  geom_abline(
    aes(
      intercept = fixed_effects['(Intercept)'],
      slope = fixed_effects['Name']),
    color = 'darkred',
    size = 2) +
  geom_abline(
    aes(
      intercept = `(Intercept)`, 
      slope = logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021,
      color = name),
    size = .5,
    alpha = .25,
    data = random_eff) 
```



================================================================================
Sample code

model_fit = lmer(trans_density ~ logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021 + (1|name),data=dataPop)
model_lm = lm(trans_density ~ logsydist + yearsince2000)

```{r}
model_lm = lm(trans_density ~ logsydist + yearsince2000, data = dataPop)
```


```{r}
gpa_lm_by_group0 = lmList(trans_density ~ yearsince2000 | name, dataPop)
gpa_lm_by_group  = coef(gpa_lm_by_group0)

gint = 
  data_frame(Mixed=coef(model_fit)$name[,1], Separate=gpa_lm_by_group[,1]) %>% 
  gather(key=Model, value=Intercept) %>% 
  ggplot(aes(x=Intercept)) +
  geom_density(aes(color=Model, fill=Model), alpha=.25) +
  scale_color_viridis_d(begin = .25, end = .75) +
  scale_fill_viridis_d(begin = .25, end = .75) +
  ggtitle('Intercepts') +
  labs(x='', y='') +
  xlim(c(1.5,4)) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.key.size=unit(2, 'mm'),
    legend.title=element_text(size=8),
    legend.text=element_text(size=8),
    legend.box.spacing=unit(0, 'in'),
    legend.position=c(.85,.75)
    )

gslopes = 
  data_frame(Mixed=coef(gpa_mixed)$student[,2], Separate=gpa_lm_by_group[,2]) %>% 
  gather(key=Model, value=Occasion) %>% 
  ggplot(aes(x=Occasion)) +
  geom_density(aes(color=Model, fill=Model), alpha=.25, show.legend=F) +
  scale_color_viridis_d(begin = .25, end = .75) +
  scale_fill_viridis_d(begin = .25, end = .75) +
  ggtitle('Slopes for occasion') +
  labs(x='', y='') +
  xlim(c(-.2,.4)) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


library(patchwork)
gint + gslopes
```




