---
title: "Mixed Models"
output:
  word_document: default
  pdf_document: default
date: "2022-10-17"
---


--------------------------------------------------------------------------------
Mixed Effects Models
--------------------------------------------------------------------------------
Some definitions: 

Fixed effects:
Fixed effects are variables that are constant across individuals. Think of ethnicity
which doesn't change OR age which changes at a constant rate over time. These
are fixed effects. 

Limitations:
Variables that are random will be treated as though they are non-random. 
"For example, in regression analysis, “fixed effects” regression fixes 
(holds constant) average effects for whatever variable you think might affect the outcome of your analysis."

There is more talk on variables that require dummy variables but this doesn't
apply to our model.



Random effects models:
The variables are random/unpredictable. 
e.g the cost of a three course dinner would greatly vary depending on location.



Mixed-Models:
A mixture of fixed and random. 


Need these packages:
install.packages("remotes")
remotes::install_github("easystats/report")

To use the package below

```{r}
library("report")
```

```{r, warning=FALSE}
x <- c("ggmap", "rgdal", "rgeos", "maptools", "dplyr", "tidyr", "tmap", "sf", "MASS", "rgeos", "gmt", "lme4", "lmerTest", "ggplot2", "sf", "tidyverse", "gganimate")
lapply(x, library, character.only = TRUE) 
```

```{r}
dataPop = read.csv("C:\\Users/Owner/OneDrive - Western Sydney University/Spring 2022/Mathematics Project/Data Sets (Need to organise)/populationLong.csv")
```

```{r}
dataPop = subset(dataPop, select = -c(numChange,perChange) )
```

```{r}
dataPop$density <- 0.0    
dataPop$density <- dataPop$pop/dataPop$area
dataPop$yearsince2000 <- dataPop$year-2000
```

```{r}
length(unique(dataPop$name))
```


```{r}
dataPop$trans_density <- sqrt(dataPop$density)
```

```{r}
syd <- st_read("C:\\Users/Owner/OneDrive - Western Sydney University/Spring 2022/Mathematics Project/Data Sets (Need to organise)/SA2_2016_AUST.shp")
greaterSyd <- syd[syd$GCC_NAME16=="Greater Sydney",]
```

```{r}
centr <- st_centroid(greaterSyd)

centroid_lat <- unlist(lapply(centr$geometry,function(l) l[2]))
centroid_long <- unlist(lapply(centr$geometry,function(l) l[1]))
```

```{r}
greaterSyd$sydist <- geodist(-33.8688,151.2093,centroid_lat,centroid_long)
greaterSyd$parradist <- geodist(-33.8148,151.0017,centroid_lat,centroid_long)
dataPop$sydist <- greaterSyd$sydist[match(dataPop$name,greaterSyd$SA2_NAME16)]
dataPop$parradist <- greaterSyd$parradist[match(dataPop$name,greaterSyd$SA2_NAME16)]

dataPop$logsydist <- log(greaterSyd$sydist[match(dataPop$name,greaterSyd$SA2_NAME16)])
dataPop$logparradist <- log(greaterSyd$parradist[match(dataPop$name,greaterSyd$SA2_NAME16)])

```

```{r}
# Drop SA2's without syddist
length(unique(dataPop$logsydist))
dataPop <- dataPop[!is.na(dataPop$logsydist),]
length(unique(dataPop$logsydist))
```

Mixed-Models:
A mixture of fixed and random. 

Fixed effects model.
```{r}
fit_fixed <- lm(trans_density~yearsince2000*logparradist+yearsince2000*logsydist,data=dataPop)
summary(fit_fixed)
```


Output Summary Interpretation:
I'm assuming we can interpret this in the same way we approached the linear
model. The only difference being the ways in which we examine the 
variables like yearsince2000:parradist and yearsince2000:sydist.

If so we can say this model performs poorly compared to the multiple linear 
regression and linear models above.

^ This performs similarly to the previous models. Accounting for roughly
59.51% of the variance in the data
The only concerning thing is that in both models yearsince2000:parradist
and yearsince2000:sydist are not apparently significant given their p-values. 


```{r}
report(fit_fixed)
```


Mixed Effect Model, Random Intercepts
```{r}
#| -> General sub scripting operator, selects top-level elements.
fit_randint <- lmer(trans_density~yearsince2000*logparradist*logsydist+(1|name),data=dataPop)
summary(fit_randint)
#plot(fit_randint)
```
Summary analysis: 

```{r}
report(fit_randint)
```




```{r}
ranEff = ranef(fit_randint)$name
#ranEff
```

Random Intercept for each SA2  much bigger than residual variation
this model better than fixed effect.


Mixed Effect Model
```{r}
fit_randslope1 <- lmer(trans_density~yearsince2000*parradist*sydist+(yearsince2000|name),data=dataPop)
summary(fit_randslope1)
#plot(fit_randslope1)
```

```{r}
report(fit_randslope1)
```


```{r}
ranEff = ranef(fit_randslope1)$name
ranEff
```

Intercept random effect is small. 


```{r}
anova(fit_randint,fit_randslope1)
```

Random slope model significantly better fit.


```{r}
dataPop$year2020 = (dataPop$yearsince2000 == 20)

dataPop$year2021= (dataPop$yearsince2000 == 21)
```


Random slope with year= 2020 and year = 2021 as predictors
```{r}
slopes_years = lmer(trans_density ~ logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021 + (yearsince2000|name),data=dataPop)


random_coef = coef(slopes_years)$name
random_coef

#row.names(random_coef)
```


```{r}
greaterSyd$coef_slope <- random_coef$`(Intercept)`[match(unique(greaterSyd$SA2_NAME16),row.names(random_coef))]


qtm(shp = greaterSyd, fill = c("coef_slope"), fill.palette = "Purples", title = "Coeficient Heat Map (Slopes)")
```



***********prediction fix************
```{r}
#p <- predict(linear_model,newdata=data.frame(logparradist=c(0,1.609438), logsydist) )
```


Random int with year= 2020 and year = 2021 as predictors
```{r}
intercepts_years = lmer(trans_density ~ logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021 + (1|name),data=dataPop)

qqnorm(resid(intercepts_years))
qqline(resid(intercepts_years))
#plot(intercepts_years)
#summary(intercepts_years)
```

```{r}
print(intercepts_years, correlation=TRUE)
```


```{r}
report(intercepts_years)
```
```{r}
anova(intercepts_years, slopes_years)
```



```{r}
random_eff = ranef(intercepts_years)$name
random_eff

random_coef = coef(intercepts_years)$name
random_coef
```



```{r}
length(greaterSyd$SA2_NAME16)
length(unique(greaterSyd$SA2_NAME16))

length(dataPop$name)
length(unique(dataPop$name))

length(unique(dataPop$sydist))

length(greaterSyd$SA2_NAME16)
```
Use the match function to fix this:
dataPop$parradist <- syd$parradist[match(dataPop$name,syd$SA2_NAME16)]

```{r}
length(unique(row.names(random_coef)))
#random_coef$`(Intercept)`
```
```{r}
greaterSyd$coef <- random_coef$`(Intercept)`[match(unique(greaterSyd$SA2_NAME16),row.names(random_coef))]


qtm(shp = greaterSyd, fill = c("coef"), fill.palette = "Greens", title = "Coeficient Heat Map (Intercepts)")
```




```{r}
length(unique(syd$coef))
```


================================================================================

Visualisation

Need this chunk to work for the next chunk
```{r}
fixed_effects = fixef(model_fit)
random_effects = 
  random_coef %>%
  mutate(name = factor(unique(dataPop$name)))
```


Since this SA2 data is from 2016 I can only really use SA2's with names consistent from 2016.
Drop missing ones?
This is an issue with trying to reproduce the next plot as well


Maybe try this with a simplier mixed model first

```{r}
dataPop %>% 
  ggplot(aes(logsydist, trans_density)) +
  geom_point(aes(color = 1), alpha = .25) +
  geom_abline(
    aes(
      intercept = fixed_effects['(Intercept)'],
      slope = fixed_effects['Sydney Dist']),
    color = 'darkred',
    size = 2) +
  geom_abline(
    aes(
      intercept = `(Intercept)`, 
      slope = logsydist,
      color = 1),
    size = .5,
    alpha = .25,
    data = random_effects) 
```



```{r}
# This is how I want to plot the random slopes
# Pretty sure
dataPop %>% 
  ggplot(aes(logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021, trans_density)) +
  geom_point(aes(color = name), alpha = .25) +
  geom_abline(
    aes(
      intercept = fixed_effects['(Intercept)'],
      slope = fixed_effects['Name']),
    color = 'darkred',
    size = 2) +
  geom_abline(
    aes(
      intercept = '(Intercept)', 
      slope = logsydist*logparradist*yearsince2000 + logsydist*logparradist*year2020 +  logsydist*logparradist*year2021,
      color = name),
    size = .5,
    alpha = .25,
    data = dataPop) 
```
